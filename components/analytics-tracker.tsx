"use client"

import { useEffect, useRef } from "react"
import { usePathname, useSearchParams } from "next/navigation"
import { trackPageView } from "@/utils/firebase-service"

export function AnalyticsTracker() {
  const pathname = usePathname()
  const searchParams = useSearchParams()
  const lastPathRef = useRef<string>("")

  useEffect(() => {
    // Evitar registros duplicados en desarrollo
    if (process.env.NODE_ENV === "development") {
      console.log("游댌 Analytics Tracker: Modo desarrollo, registro limitado")
    }

    const handleRouteChange = async () => {
      const path = pathname + (searchParams?.toString() ? `?${searchParams.toString()}` : "")

      // Evitar registrar la misma ruta m칰ltiples veces
      if (path === lastPathRef.current) return
      lastPathRef.current = path

      try {
        const title = document.title
        const referrer = document.referrer

        console.log(`游늵 Registrando vista de p치gina: ${path}`)
        await trackPageView(path, title, referrer)
      } catch (error) {
        console.error("Error al registrar vista de p치gina:", error)
      }
    }

    // Registrar la vista de p치gina inicial
    handleRouteChange()

    // No necesitamos un listener para cambios de ruta ya que usePathname y useSearchParams
    // se actualizar치n autom치ticamente y este efecto se ejecutar치 de nuevo
  }, [pathname, searchParams])

  return null
}

export default AnalyticsTracker
